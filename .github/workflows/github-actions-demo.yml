name: Auto-Merge Approved PRs

on:
  workflow_dispatch: # Allow manual triggering only

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process Approved PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Track if any PRs were merged
          merged_count=0
          merged_prs=""
          
          # Get all open PRs
          prs=$(gh pr list --state open --json number,title,labels,mergeable --limit 100)
          
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            mergeable=$(echo "$pr" | jq -r '.mergeable')
            labels=$(echo "$pr" | jq -r '.labels[].name')
            
            echo "Processing PR #$pr_number: $pr_title"
            
            # Check if PR has "DO NOT MERGE" label
            if echo "$labels" | grep -qi "do not merge"; then
              echo "  â­ï¸  Skipping: Has 'DO NOT MERGE' label"
              continue
            fi
            
            # Get review status separately
            reviews=$(gh pr view "$pr_number" --json reviews --jq '.reviews[] | select(.state == "APPROVED") | .author.login' | wc -l)
            
            if [ "$reviews" -lt 1 ]; then
              echo "  â­ï¸  Skipping: Not approved (approvals: $reviews)"
              continue
            fi
            
            echo "  âœ… PR has $reviews approval(s)"
            
            # Check if PR has conflicts
            if [ "$mergeable" = "CONFLICTING" ]; then
              echo "  â­ï¸  Skipping: Has merge conflicts"
              continue
            fi
            
            # Get PR details for the tag
            pr_body=$(gh pr view "$pr_number" --json body --jq '.body' | head -c 500)
            pr_author=$(gh pr view "$pr_number" --json author --jq '.author.login')
            
            echo "  âœ… Attempting to merge and rebase PR #$pr_number"
            
            # Merge the PR with rebase
            if gh pr merge "$pr_number" --rebase --auto=false; then
              echo "  âœ… Successfully merged PR #$pr_number"
              
              # Track merged PR
              merged_count=$((merged_count + 1))
              merged_prs="${merged_prs}#${pr_number} "
              
              # Fetch the latest changes
              git fetch origin
              git checkout main
              git pull origin main
              
              # Create a tag with PR number and summary in kebab-case
              tag_name=$(echo "pr-$pr_number-$pr_title" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
              tag_message="PR #$pr_number: $pr_title
              
              Author: @$pr_author
              
              Summary:
              ${pr_body:0:500}"
              
              # Create and push the tag
              git tag -a "$tag_name" -m "$tag_message"
              git push origin "$tag_name"
              
              echo "  ğŸ·ï¸  Created tag: $tag_name"
            else
              echo "  âŒ Failed to merge PR #$pr_number"
            fi
            
            # Add a small delay between PRs
            sleep 2
          done
          
          # Store merged count for next step
          echo "$merged_count" > /tmp/merged_count.txt
          echo "$merged_prs" > /tmp/merged_prs.txt

      - name: Update Build Number
        if: always()
        run: |
          # Check if any PRs were merged
          if [ -f /tmp/merged_count.txt ]; then
            merged_count=$(cat /tmp/merged_count.txt)
            merged_prs=$(cat /tmp/merged_prs.txt)
          else
            merged_count=0
          fi
          
          if [ "$merged_count" -gt 0 ]; then
            echo "ğŸ“¦ $merged_count PR(s) were merged: $merged_prs"
            echo "ğŸ“¦ Updating build number..."
            
            # Ensure we're on main with latest changes
            git checkout main
            git pull origin main
            
            # Get current build number from package.json (or set to 0 if not exists)
            current_build=$(jq -r '.build // 0' package.json)
            new_build=$((current_build + 1))
            
            echo "ğŸ“¦ Updating build number from $current_build to $new_build"
            
            # Update build number in package.json
            jq --arg build "$new_build" '.build = ($build | tonumber)' package.json > package.json.tmp && mv package.json.tmp package.json
            
            # Run npm build
            echo "ğŸ”¨ Running npm run build"
            npm run build
            
            # Commit build number updates and build artifacts
            git add -A
            if git diff --staged --quiet; then
              echo "â„¹ï¸  No changes to commit from build"
            else
              git commit -m "chore: bump build number to $new_build [skip ci]
              
              Automated build number update after merging PRs: $merged_prs"
              git push origin main
              echo "âœ… Committed and pushed build updates"
            fi
          else
            echo "â„¹ï¸  No PRs were merged, skipping build number update"
          fi

      - name: Summary
        run: |
          echo "Auto-merge process completed"
          echo "Tagged merges can be viewed with: git tag -l 'pr-*'"